version: '3.8'

services:
  # ==========================================
  # DATABASE - SQL SERVER
  # ==========================================
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: foodfast_db
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=${DB_PASSWORD}
      - MSSQL_PID=Developer
    ports:
      - "1444:1433"
    volumes:
      - sqlserver_data:/var/opt/mssql
    networks:
      - foodfast_network
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P ${DB_PASSWORD} -Q "SELECT 1" -C || exit 1
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # ==========================================
  # USER SERVICE - Port 8001
  # ==========================================
  user_service:
    build: ./user_service
    container_name: user_service
    environment:
      - DATABASE_URL=mssql+pyodbc://sa:${DB_PASSWORD}@sqlserver:1433/${DB_NAME_USER}?driver=ODBC+Driver+18+for+SQL+Server&TrustServerCertificate=yes
      - JWT_SECRET=${JWT_SECRET}
      - SERVICE_PORT=8001
    ports:
      - "8001:8001"
    depends_on:
      sqlserver:
        condition: service_healthy
    networks:
      - foodfast_network
    restart: unless-stopped

  # ==========================================
  # PRODUCT SERVICE - Port 8002
  # ==========================================
  product_service:
    build: ./product_service
    container_name: product_service
    environment:
      - DATABASE_URL=mssql+pyodbc://sa:${DB_PASSWORD}@sqlserver:1433/${DB_NAME_PRODUCT}?driver=ODBC+Driver+18+for+SQL+Server&TrustServerCertificate=yes
      - JWT_SECRET=${JWT_SECRET}
      - USER_SERVICE_URL=${USER_SERVICE_URL}
      - SERVICE_PORT=8002
    ports:
      - "8002:8002"
    volumes:
      - product_images:/app/static/images
    depends_on:
      sqlserver:
        condition: service_healthy
    networks:
      - foodfast_network
    restart: unless-stopped

  # ==========================================
  # ORDER SERVICE - Port 8003
  # ==========================================
  order_service:
    build: ./order_service
    container_name: order_service
    environment:
      - DATABASE_URL=mssql+pyodbc://sa:${DB_PASSWORD}@sqlserver:1433/${DB_NAME_ORDER}?driver=ODBC+Driver+18+for+SQL+Server&TrustServerCertificate=yes
      - JWT_SECRET=${JWT_SECRET}
      - USER_SERVICE_URL=${USER_SERVICE_URL}
      - PRODUCT_SERVICE_URL=${PRODUCT_SERVICE_URL}
      - DRONE_SERVICE_URL=${DRONE_SERVICE_URL}
      - SERVICE_PORT=8003
    ports:
      - "8003:8003"
    depends_on:
      sqlserver:
        condition: service_healthy
    networks:
      - foodfast_network
    restart: unless-stopped

  # ==========================================
  # PAYMENT SERVICE - Port 8004
  # ==========================================
  payment_service:
    build: ./payment_service
    container_name: payment_service
    environment:
      - DATABASE_URL=mssql+pyodbc://sa:${DB_PASSWORD}@sqlserver:1433/${DB_NAME_PAYMENT}?driver=ODBC+Driver+18+for+SQL+Server&TrustServerCertificate=yes
      - JWT_SECRET=${JWT_SECRET}
      - USER_SERVICE_URL=${USER_SERVICE_URL}
      - ORDER_SERVICE_URL=${ORDER_SERVICE_URL}
      - SERVICE_PORT=8004
    ports:
      - "8004:8004"
    depends_on:
      sqlserver:
        condition: service_healthy
    networks:
      - foodfast_network
    restart: unless-stopped

  # ==========================================
  # DRONE SERVICE - Port 8005 ‚≠ê NEW
  # ==========================================
  drone_service:
    build: ./drone_service
    container_name: drone_service
    environment:
      - DATABASE_URL=mssql+pyodbc://sa:${DB_PASSWORD}@sqlserver:1433/${DB_NAME_DRONE}?driver=ODBC+Driver+18+for+SQL+Server&TrustServerCertificate=yes
      - JWT_SECRET=${JWT_SECRET}
      - ORDER_SERVICE_URL=${ORDER_SERVICE_URL}
      - SERVICE_PORT=8005
      - GPS_UPDATE_INTERVAL=${DRONE_GPS_UPDATE_INTERVAL}
      - MAX_SPEED=${DRONE_MAX_SPEED}
      - MAX_DISTANCE=${DRONE_MAX_DISTANCE}
      - MIN_BATTERY=${DRONE_MIN_BATTERY}
      - BATTERY_PER_KM=${DRONE_BATTERY_PER_KM}
      - DEFAULT_LAT=${DRONE_DEFAULT_LAT}
      - DEFAULT_LNG=${DRONE_DEFAULT_LNG}
    ports:
      - "8005:8005"
    depends_on:
      sqlserver:
        condition: service_healthy
    networks:
      - foodfast_network
    restart: unless-stopped

  # ==========================================
  # CART SERVICE - Port 8006
  # ==========================================
  cart_service:
    build: ./cart_service
    container_name: cart_service
    environment:
      - DATABASE_URL=mssql+pyodbc://sa:${DB_PASSWORD}@sqlserver:1433/${DB_NAME_CART}?driver=ODBC+Driver+18+for+SQL+Server&TrustServerCertificate=yes
      - JWT_SECRET=${JWT_SECRET}
      - PRODUCT_SERVICE_URL=${PRODUCT_SERVICE_URL}
      - SERVICE_PORT=8006
    ports:
      - "8006:8006"
    depends_on:
      sqlserver:
        condition: service_healthy
    networks:
      - foodfast_network
    restart: unless-stopped

  # ==========================================
  # API GATEWAY - Port 8000 (Entry Point)
  # ==========================================
  api_gateway:
    build: ./api_gateway
    container_name: api_gateway
    environment:
      - USER_SERVICE_URL=${USER_SERVICE_URL}
      - PRODUCT_SERVICE_URL=${PRODUCT_SERVICE_URL}
      - ORDER_SERVICE_URL=${ORDER_SERVICE_URL}
      - PAYMENT_SERVICE_URL=${PAYMENT_SERVICE_URL}
      - DRONE_SERVICE_URL=${DRONE_SERVICE_URL}
      - CART_SERVICE_URL=${CART_SERVICE_URL}
    ports:
      - "8000:8000"
    depends_on:
      - user_service
      - product_service
      - order_service
      - payment_service
      - drone_service
      - cart_service
    networks:
      - foodfast_network
    restart: unless-stopped

  # ==========================================
  # FRONTEND - Port 3000
  # ==========================================
  frontend:
    build: ./frontend
    container_name: frontend
    environment:
      - CHOKIDAR_USEPOLLING=true
      - VITE_API_URL=http://localhost:8000
    ports:
      - "3000:3000"
    depends_on:
      - api_gateway
    networks:
      - foodfast_network
    restart: unless-stopped

# ==========================================
# NETWORKS & VOLUMES
# ==========================================
networks:
  foodfast_network:
    driver: bridge

volumes:
  sqlserver_data:
  product_images: